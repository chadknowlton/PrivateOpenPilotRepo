# Code Analysis for Software Security Engineering
## Code Review Strategy
OpenPilot contains 1,886 files, and roughly half of them are python scripts. The rest of the files consist of a combination of bash and C, C++ files. While the use of an automated tool was with in the realm of possibility, our team felt it was necessary to first try and scan the bulk of code using an automated scanner. It is worth mentioning that OpenPilot is a massively popular project meaning that our chances of finding active vulnerbailities may be slim. However, we wanted to give an automated scanner a try to test the waters and get a feel for the vulnerbailities we should expect to see. 


Jose and Jack both have experience using SonarCloud and felt it was the best option in going forth to scan the Python code first. We first forked the OpenPilot repository, added a `build.yml` plugin to our builds, and developed a `sonar-project.properties` with some minor changes to fit our scan criteria. To be able to compile the python code, we needed our 'sonar-project.properties' file to ignore all forms of C code to run properly. We did so be adding the lines `sonar.c.file.suffixes=-` , `sonar.cpp.file.suffixes=-`, and `sonar.objc.file.suffixes=-`. This netted us with 7 bugs and 182 vulnerabilities to manually check over. While we believe there are a number of false positives, our team is satisfied with the results returned, but this needed to be changed in order to run the scan and have it pickup the C code as well. 

In order for SonarCloud to correctly analyze C/C++/Objective-C code it needs to know the configurations that are used to build the code. In order to achieve this a development environment needs to be setup, Openpilot provides instructions on how to do this and can be found [here](https://github.com/commaai/openpilot/tree/master/tools). The development environment was setup on a machine running Ubuntu 20.04 since this is what Openpilot is developed on. Once the development environment was setup `sonar-scanner` and `build-wrapper-linux-x86-64` had to also be installed. Next `build-wrapper-linux-x86-64` needs to be ran with the command that builds the C code in our case that command looks like `build-wrapper-linux-x86-64 --out-dir buid_out scons -j$(nproc)`, the `scons -j$(nproc)` is the command that builds out all of the C code in the project. The `build-wrapper-linux-x86-64` creates a two files in the `out-dir`, a log file and a json file, these are the files needed in order to complete the analysis. Then this entry, `sonar.cfamily.build-wrapper-output=buid_out`, needs to be added to the `sonar-properties` file for `sonar-scanner` to know where to find the files generated by the build wrapper. lastly the `sonar-scanner` command is ran in order to get the analysis results.

In exploring how to analyze the C code of Openpilot, we had also found success using Visual Code Grepper (VCG). Since Visual Code Grepper performs a static code analysis, it didnâ€™t require for the C files to be compiled before carrying out a scan. For this analysis tool, we downloaded the 0.8.10 release build of Openpilot and VCG version 2.2.0. Once installed, the GUI of VCG allowed us to select the target directory where the Openpilot-0.8.10 root folder was located locally on the machine, perform a full scan on it, and export the table summarizing its findings as a csv file.



## Findings From Code Review
SonarCloud Scan Results: https://sonarcloud.io/summary/overall?id=Rafterman29_openpilot

## 

### CWE-200: Exposure of Sensitive Information to an Unauthorized Actor
Link: https://cwe.mitre.org/data/definitions/200.html

Code Review Source:
* https://sonarcloud.io/project/security_hotspots?id=Rafterman29_openpilot&hotspots=AX0lk5uqEafnvRiIF-DU
* https://sonarcloud.io/project/security_hotspots?id=Rafterman29_openpilot&hotspots=AX0lk5uiEafnvRiIF-C4
* https://sonarcloud.io/project/security_hotspots?id=Rafterman29_openpilot&hotspots=AX0lk5uiEafnvRiIF-C5

#### athnad.py
` if r.status_code == 302 and r.headers['Location'].startswith("http://u.web2go.com"):` 

#### helpers.py
`requests.put(f'http://{host}:{port}/qlog.bz2', data='')` and ` return func(*args, f'http://{host}:{port}', **kwargs)` 

In our automated scan of python scripts through SonarCloud, one concerning result returned was the use of mapped `http` addresses. This corresponds to CWE-200: Exposure of Sensitive Information to an Unauthorized Actor. Our results suggested use to ask whether our application data transits over a network that is considered untrusted, and whether
compliance rules require the service to encrypt data in transit. Both of which we answered yes to.We recommned mapping these return functuons to `https` addresses to mitigate sensitive information being transmitted through insecure channels. 

##

### CWE-732: Incorrect Permission Assignment for Critical Resource
Link: https://cwe.mitre.org/data/definitions/732.html

Code Review Source:
* https://sonarcloud.io/project/security_hotspots?id=Rafterman29_openpilot&hotspots=AX0lk528EafnvRiIF-LK#

```
    if input(msg) == 'y':
        print("Dowloading {}".format(url))
        with urllib.request.urlopen(url) as response, open(tera_path, 'wb') as out_file:
            shutil.copyfileobj(response, out_file)
        print("Successfully downloaded t_renderer.")
        os.chmod(tera_path, 0o755)
        return tera_path
    msg_cancel = "\nYou cancelled automatic download.\n\n"
    msg_cancel += manual_install
    msg_cancel += "Once installed re-run your script.\n\n"
```
 
This CWE states that " The product specifies permissions for a security-critical resource in a way that allows that resource to be read or modified by unintended actors." This risk was identified as a possibility within the `utils.py` file located in `\pyextra\acados_template`. On line 181 chmod is used to assign file read/write/execute permissions to user groups, and secure coding practices specify that the most restrictive permissions possible should be assigned to files and directories. Assigning less restrictive permissions can lead to unintended access to critical resource files. To mitigate the risk, SonarCloud recommended configuring the chmod to mask for file owner permissions.

We determined that this identified risk was relatively acceptable within Openpilot, given where the risk was identified and its implementation. The resource file in question is a tera renderer utility which lets anybody read and execute the file, but only allows for the owner to write to it. Since the file will be running in a context which is neither a multi-user environment nor does it contain any confidential  information, it is acceptable for everyone to read it.  

## 

### CWE-259: Use of Hard-coded Password
Link: https://cwe.mitre.org/data/definitions/259.html

Code Review Source:
* https://sonarcloud.io/project/security_hotspots?id=Rafterman29_openpilot&hotspots=AX0_TGjHgvHzTIyGNH5H

```
QString adapter;  // Path to network manager wifi-device
  QDBusConnection bus = QDBusConnection::systemBus();
  unsigned int raw_adapter_state;  // Connection status https://developer.gnome.org/NetworkManager/1.26/nm-dbus-types.html#NMDeviceState
  QString connecting_to_network;
  QString tethering_ssid;
  const QString defaultTetheringPassword = "swagswagcomma";
  ```
  
 The use of a hard-code password could lead to a high risk of authentication failure within the system. This vulnerbaility was security issue was detected within  `selfdrive/ui/qt/offroad/wifiManager.h`. OpenPilot software is risk of credential leakage since this source is used within the production enviroment. Leakage or altering of these credentials could further lead the end user to have snesitive information leaked to the API service. Removal of the hard-coded password is strongly recommended. 
 
## 

### CWE-326: Inadequate Encryption Strength
Link: https://cwe.mitre.org/data/definitions/326.html

Code Review Source:
* https://sonarcloud.io/project/issues?id=Rafterman29_openpilot&open=AX0_TGgAgvHzTIyGNH1j&resolved=false&types=VULNERABILITY

```
size_t getRemoteFileSize(const std::string &url) {
  CURL *curl = curl_easy_init();
```
```
  std::map<CURL *, MultiPartWriter> writers;
  const int part_size = content_length / parts;
  for (int i = 0; i < parts; ++i) {
    CURL *eh = curl_easy_init();
```

The automated scanner detected these code snippets within `selfdrive/ui/replay/util.cc` due to an inadequate TLS version being used. It is recommended to enforce TLS 1.2 as the minimum protocol version and disallow versions like TLS 1.0. Failure in doing so could open the door to downgrade attacks where a malicious actor who is able to intercept the connection could modify the requested protocol version and downgrade it to a less secure version.

## 

### CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer
Link: https://cwe.mitre.org/data/definitions/119.html

Code Review Source:
* https://sonarcloud.io/project/issues?cwe=119&directories=selfdrive/boardd&id=Rafterman29_openpilot&open=AX0_THL8gvHzTIyGNIWv&resolved=false&severities=BLOCKER&types=BUG
* https://sonarcloud.io/project/issues?cwe=119&directories=selfdrive/boardd&id=Rafterman29_openpilot&open=AX0_THL8gvHzTIyGNIWw&resolved=false&severities=BLOCKER&types=BUG

```
memcpy(&chunk[tail_size], &data[i+1], chunk_len);
```
```
memcpy(tail, &chunk[pos], tail_size);
```

The automated scanner detected these code snippets within `selfdrive/boardd/panda.cc` due to a memory copying function, `memcpy` overflowing the destination buffer. It is recommended that memory should be explicitly bound. Failure in doing so could open the door to a malicious acto cause a buffer overflow attack where they coud then read memory, execute arbitrary code, or even perform a denial of service attack

## 

### CWE-401: Missing Release of Memory after Effective Lifetime
Link: https://cwe.mitre.org/data/definitions/401.html

Code Review Source:
* https://sonarcloud.io/project/issues?cwe=401&id=Rafterman29_openpilot&open=AX0_TGoFgvHzTIyGNIDR&resolved=false&severities=BLOCKER
* https://sonarcloud.io/project/issues?cwe=401&id=Rafterman29_openpilot&open=AX0_TGkygvHzTIyGNH9H&resolved=false&severities=BLOCKER

```
QObject::connect(repeater, &RequestRepeater::receivedResponse, [=](QString resp) {
        if (resp != "null") {
          if (params.get("NavDestination").empty()) {
            qWarning() << "Setting NavDestination from /next" << resp;
            params.put("NavDestination", resp.toStdString());
          } else {
            qWarning() << "Got location from /next, but NavDestination already set";
          }
          // Send DELETE to clear destination server side
          deleter->sendRequest(url, HttpRequest::Method::DELETE);
        }
      });
```
```
  setStyleSheet(QString(R"(
    QPushButton {
      font-size: 75px;
      margin-left: %1px;
      margin-right: %1px;
      margin-top: %2px;
      margin-bottom: %2px;
      padding: 0px;
      border-radius: 10px;
      color: #dddddd;
      background-color: #444444;
    }
    QPushButton:pressed {
      background-color: #333333;
    }
  )").arg(key_spacing_vertical / 2).arg(key_spacing_horizontal / 2));
}
```

The automated scanner detected these code snippets within `selfdrive/ui/qt/maps/map_settings.cc` and `selfdrive/ui/qt/widgets/keyboard.cc` due to memory not being released after it is no longer in use. It is recommended that memory is allocated and freed within the same function. Failure in doing so could open the door to a malicious actor to trigger a memory leak and launch a denial of service attack.

## 

### CWE-327: Use of a Broken or Risky Cryptographic Algorithm
Link: https://cwe.mitre.org/data/definitions/327.html

Code Review Source:
* https://sonarcloud.io/project/security_hotspots?id=Rafterman29_openpilot&hotspots=AX0lk5y0EafnvRiIF-E9
* https://sonarcloud.io/project/security_hotspots?id=Rafterman29_openpilot&hotspots=AX0lk5uqEafnvRiIF-DD

#### athnad.py
`  upload_id = hashlib.sha1(str(item).encode()).hexdigest()` 

In our automated scan of python scripts through SonarCloud, one concerning result returned was the use of the `sha1 algorithm` to hash the data. It corresponds to CWE-327: Use of a Broken or Risky Cryptographic Algorithm. `SHA-1` is no longer considered secure, and we can calculate the hash value with little computational effort. We recommend using `SHA-256` to hash the value. 


## Summary of Key Findings
After using SonarCloud to assist with the automated static code analysis for Openpilot, we have identified the following major CWEs. If addressed properly, implemented fixes in these areas stand to improve the security of the Openpilot software. 

* [CWE-200: Exposure of Sensitive Information to an Unauthorized Actor](https://cwe.mitre.org/data/definitions/200.html): Since http uses plaintext, it is easy for communications to be sniffed or tampered with by an attacker. SonarCloud identified at least three different locations where http was used within Openpilot. This is a vulnerability which could be avoided relatively easily by switching the transfer protocol of all external communications which currently use http to https.

* [CWE-326: Inadequate Encryption Strength](https://cwe.mitre.org/data/definitions/326.html): For transferring data via url, curl is used within Openpilot. To make sure that transfer is secure, it must be verified that the TLS version implemented is â‰¥ 1.2. Older versions allow for the TLS to be downgraded, opening the door for known security vulnerabilities which were fixed to be taken advantage of by an attacker.

* 
 
* 




## Contributions to OpenPilot



## Project Board
Link to team project board: https://github.com/chadknowlton/PrivateOpenPilotRepo/projects/4



## Teamwork Reflection
Our first priority when it came to starting this assignmnet was finishing the weekly quiz as early as possible. This set us up for two meetings (11/18 & 11/19) where we discussed our goals, challenges expected, and **Code Review Strategy**. We eventually settled on SonarCloud due to Jose and Jack having experience with the product. The Thursday meeting also allowed us to set our individuals goals in contributions to the assignment.

**Jack Rafter & Kyle Phipps:** Setup SonarCloud to read the python scripts, and document steps into our **Code Review Strategy**. Then analyze the returned data, and add to **Findings From Code Review**. 

**Dip Kiran Pradhan Newar & Jose Hernandez:** Setup SonarCloud to read the C & C++ scripts, and document steps into our **Code Review Strategy**. Then analyze the returned data, and add to **Findings From Code Review**. 

**Chad Middleton:** Discuss the findings with the team, determine which should be put into our **Summary of Key Findings**. 

**Full Team:** Meet and discuss our **Contributions to OpenPilot** portion. 

Our final goal was to have the document setup and finalized before our meeting with professor. Our team successfully setup our SonarCloud scanner, and documented the found CWE's as of 11/21. From here, we were then able to summarize the CWEs that we felt would best contribute to the overall security of OpenPilot, and wrote out our **Summary of Key Findings**.

As this is our final submission for the class, our team really wanted to get a head-start to give us time to breath and work through the assignmnet in close detail. Our communication strategy and approach in assigning roles has really helped us to a point in which we wished we had pursued this strategy earlier in the semester. To conclude, our communication, presence, and overall individual work has been excellent for this assignment. 
